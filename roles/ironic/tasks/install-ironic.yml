---


- name: apt install software-properties packages on ubuntu
  apt:
    name: software-properties-common
    state: present
  when: ansible_distribution in ["Ubuntu","Debian"]

- name: add ironic repository on ubuntu
  apt_repository:
    repo: cloud-archive:{{ ironic_release }}
  when:
    - localrepo_enabled | bool == false
    - ansible_distribution in ["Ubuntu","Debian"]

- name: add ironic repository on centos
  yum:
    name: centos-release-openstack-{{ ironic_release }}
    state: present
  when:
    - localrepo_enabled | bool == false
    - ansible_distribution in ["CentOS","RedHat"]
  
- name: create ironic database
  mysql_db:
    name: "ironic"
    state: present
    login_user: "ironic"
    login_password: "password"
  register: check_created_db


- name: yum install ironic-api package required for ironic standalone
  yum:
    name: openstack-ironic-api
    state: present
  when: ansible_distribution in ["CentOS","RedHat"]

- name: yum install ironic-conductor package required for ironic standalone
  yum:
    name: openstack-ironic-conductor
    state: present
  when: ansible_distribution in ["CentOS","RedHat"]

- name: yum install packages required for ironic standalone
  yum:
    name: "{{ item }}"
    state: present
  loop:
    - python-ironicclient
    - qemu-img
    - genisoimage
    - iscsi-initiator-utils
    - psmisc
  when: ansible_distribution in ["CentOS","RedHat"]

- name: apt install packages required for ironic standalone
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop:
    - ironic-api
    - ironic-conductor
    - python-ironicclient
    - open-iscsi
  when: ansible_distribution in ["Ubuntu","Debian"]

- name: ensures /etc/ironic directory exists
  file: path=/etc/ironic state=directory

- name: edit ironic configuration file
  template:
    src: "ironic.conf.j2"
    dest: "/etc/ironic/ironic.conf"

- name: create ironic db schema
  command: ironic-dbsync --config-file /etc/ironic/ironic.conf create_schema
  when: check_created_db.changed | bool == true

- name: upgrade ironic db schema
  command: ironic-dbsync --config-file /etc/ironic/ironic.conf upgrade
  when: check_created_db.changed | bool == false

- name: restart ironic services
  systemd:
    name: "{{ item }}"
    state: restarted
    enabled: yes
  loop:
    - openstack-ironic-api
    - openstack-ironic-conductor

- name: create ironic lib directory
  file:
    path: "{{ item }}"
    state: directory
    owner: ironic
    group: ironic
    mode: 0777
    recurse: yes
  with_items:
    - /var/lib/ironic
    - /var/lib/ironic/ubuntu-deploy
    - /var/lib/ironic/centos7-user

- name: copy ubuntu deploy image to ironic lib directory
  copy:
    src: "{{ item }}"
    dest: /var/lib/ironic/ubuntu-deploy
    mode: 0777
  with_items:
    - ubuntu-deploy.initramfs
    - ubuntu-deploy.kernel

- name: copy centos user image to ironic lib directory
  copy:
    src: "{{ item }}"
    dest: /var/lib/ironic/centos7-user
    mode: 0777
  with_items:
    - user-centos7.initramfs
    - user-centos7.kernel
    - user-centos7.qcow2
